/**
* File:        CongaPreviewController.cls
* Project:     GAP
* Date:        19/8/2017
* Created By:  Abdul Kadir
* Test Class(s) : CongaPreviewControllerTest(82%)
* *************************************************************************
* @description This class purpose to show the preview Document generated by conga composer.
* *************************************************************************
* History:
* Modified By : Avinash Shukla BK-2871/BK-2973/74
* Modified By : Akshi Arora BK-2871/BK-2973/74, [Aishwarya BK-4271,4362 May 28 2020],[Aishwarya BK-5477 30 June 2020], [Aishwarya BK-6385/6386 July 27 2020]
                [Aishwarya BK-7477 Aug 14 2020]
* Modified By : Rajesh kumar yadav BK-4270('&DocuSignR5ID=' + oQuote.ID and congaAdditionalParamsBrazil)
* Modified By : Rajesh Kumar - BK-10316 on 05-11-2020 -- Notes And Attachment
*/
public without sharing  class CongaPreviewController {
    public String docPath {set; get;}
    public string quoteId {get; set;}
    public string sessionId;
    public string serverURL;
    public string pDAs;
    public string sUrl;
    public string cC;
    public string tId;
    public string template;
    public string congaQueries;
    public string congaQueriesOOQ;
    public SBQQ__Quote__c oQuote {get; set;}
    public String docName {get; set;}
    public string pageName {get; set;}
    public string congaAdditionalParams;
    public string CongaAdditionalDocParam;
    //BK-6268
    public SBQQ__Quote__c oQuoteTCID {get;set;}
    //BK-4270
    public string congaAdditionalParamsBrazil;
    //BK-13894 Shiv Raghav
    public String termAndCondition = '';
    
    /**
    * [CongaPreviewController constructor quoteId get form URL ]
    * @return [null]
    */
    public CongaPreviewController() {
        template = '';
        pDAs = '';
        sUrl = '';
        cC = '';
        tId = '';
        sessionId = UserInfo.getSessionId();
        congaQueries = System.label.conga_queries;
        congaQueriesOOQ = System.label.conga_queries_Online_Opportunity_Quote;
        congaAdditionalParams = System.label.conga_Additional_Params;
        congaAdditionalParamsBrazil = System.label.conga_Additional_Params_Brazil;
        CongaAdditionalDocParam = System.label.Conga_Additional_Doc_Param;
        oQuote = new SBQQ__Quote__c();
        quoteId = ApexPages.currentPage().getParameters().get('quoteId');
        String [] paramsList = quoteId.split('~');
        quoteId = paramsList[0].trim();
        pageName = paramsList[1].trim();
        if (pageName == 'sD') {
            template = paramsList[2].substringAfter('^').trim();
            pDAs = paramsList[3].substringAfter('^').trim();
            sUrl = paramsList[4].substringAfter('^').trim();
            cC = paramsList[5].substringAfter('^').trim();
            tId = paramsList[6].substringAfter('^').trim();
        }

        oQuote = [select id, Name,SBQQ__Opportunity2__r.EventEdition__r.Mix_Supply_Terms_and_Condition__c , conga_contract_template_id__c,Online_Opportunity_Quote_Check__c,Online_Opportunity_Quote__c,Event_Director__c,Event_Series_Country__c,SBQQ__Opportunity2__r.Is_Barter_Opportunity__c,SBQQ__Opportunity2__r.Total_FOC_Product_Count__c, National_contract_and_TC_Ids__c, Witness_Contact__c, SBQQ__Opportunity2__r.Legal_Representative_1__c, Quote_Line_Deliverables__c, Show_Deliverables__c, Is_a_Local_Company__c, conga_quote_template_id__c, Allow_Docusign_Counter_Sign__c,  Quote_Event_Edition__c, SBQQ__PrimaryContact__c, Primary_Contact_Info__c, Next_Version__c, term_conditionIds__c, SBQQ__Opportunity2__r.EventEdition__r.Alternative_Terms_Condition_Template__c,SBQQ__Opportunity2__r.EventEdition__r.Terms_Condition_Template__c,SBQQ__Opportunity2__r.EventEdition__r.Enable_Additional_Documents_in_Docusign__c,SBQQ__Type__c, Contract_Type__c from SBQQ__Quote__c where id = :quoteId limit 1];
        if(oQuote.Online_Opportunity_Quote_Check__c == true) {           congaQueries = congaQueries +','+congaQueriesOOQ+'='+oQuote.Online_Opportunity_Quote__c;

        }else{
            congaQueries = congaQueries;
        } 
        
        //BK-13894 Shiv Raghav
        if(oQuote.Online_Opportunity_Quote_Check__c && oQuote.SBQQ__Opportunity2__r.EventEdition__r.Alternative_Terms_Condition_Template__c != null)
        {
            termAndCondition = oQuote.SBQQ__Opportunity2__r.EventEdition__r.Alternative_Terms_Condition_Template__c;
        }
        else if(oQuote.SBQQ__Opportunity2__r.EventEdition__r.Terms_Condition_Template__c != null)       {           termAndCondition = oQuote.SBQQ__Opportunity2__r.EventEdition__r.Terms_Condition_Template__c;
        }
        
          /*BK-22779 Added this to check mixed product in quote Line*/
      list < SBQQ__QuoteLine__c > objQLIList = [select id,SBQQ__Product__r.Delegate_Product__c, SBQQ__Quote__r.SBQQ__Opportunity2__c, SBQQ__Product__c, SBQQ__Quote__c, SBQQ__Quote__r.SBQQ__Account__c, SBQQ__Product__r.id, SBQQ__Product__r.Name, SBQQ__Product__r.Description, SBQQ__Product__r.Description_in_Alt_Language__c FROM SBQQ__QuoteLine__c WHERE SBQQ__Quote__c =: quoteId Order By SBQQ__Product__r.name Asc];

        integer countDelegate=0;
        integer countNonDelegate=0;
       System.debug('test=='+objQLIList);
      if(!objQLIList.isEmpty()){
            for(SBQQ__QuoteLine__c sbquote:objQLIList){
                  
                   if(sbquote.SBQQ__Product__r.Delegate_Product__c){
                       countDelegate=countDelegate+1;
                       
                   }
                   else if(!sbquote.SBQQ__Product__r.Delegate_Product__c){
                       countNondelegate=countNonDelegate+1;
                   }          
            }
              System.debug('countDelegate=='+countDelegate);
              System.debug('countNonDelegate=='+countNonDelegate);
                            System.debug('countNonDelegate=='+oQuote.SBQQ__Opportunity2__r.EventEdition__r.Mix_Supply_Terms_and_Condition__c);

            if(countDelegate>0 && countNonDelegate>0 && oQuote.SBQQ__Opportunity2__r.EventEdition__r.Mix_Supply_Terms_and_Condition__c != Null){
                   termAndCondition=oQuote.SBQQ__Opportunity2__r.EventEdition__r.Mix_Supply_Terms_and_Condition__c;
                   System.debug('termAndCondition=='+termAndCondition);
                }
           /* else if(countDelegate>0 && countNonDelegate==0 && oQuote.SBQQ__Opportunity2__r.EventEdition__r.DS_Terms_Condition_Template__c != Null){
                    termAndCondition = oQuote.SBQQ__Opportunity2__r.EventEdition__r.DS_Terms_Condition_Template__c;
                   
                }*/
            else if(countDelegate==0 && countNonDelegate>0 && oQuote.SBQQ__Opportunity2__r.EventEdition__r.Terms_Condition_Template__c != null){
                    termAndCondition = oQuote.SBQQ__Opportunity2__r.EventEdition__r.Terms_Condition_Template__c;
                }
            else  if(oQuote.Online_Opportunity_Quote_Check__c && oQuote.SBQQ__Opportunity2__r.EventEdition__r.Alternative_Terms_Condition_Template__c != null){
                    termAndCondition = oQuote.SBQQ__Opportunity2__r.EventEdition__r.Alternative_Terms_Condition_Template__c;
            }
        }
         /*BK-22779 Added this to check mixed product in quote Line*/
        
        DateTime objDate1 = DateTime.now();
        if (template == 'Quote') {
            docName = oQuote.Name + '-' + String.valueOf(objDate1) + '-SignedQuote';
        } else {
            docName = oQuote.Name + '-' + String.valueOf(objDate1) + '-SignedContract';
        }
    }
    /**
    * @description show the generated pdf.
    * @param
    * @return
    */
    public void showDoc() {
        if (quoteId != null) {
            if ((pageName.equals('Preview') || pageName.equals('sD'))) {
                List<ContentDocumentLink> lstContentDocumentLink = [SELECT Id, ContentDocument.Title, LinkedEntityId, ContentDocumentId, Visibility, ShareType FROM ContentDocumentLink where LinkedEntityId = :quoteId order by ContentDocument.Createddate Desc limit 1];

                if (!lstContentDocumentLink.isEmpty()) {                    LIst<ContentVersion> lstContentVersion = [SELECT Id,Title, ContentDocumentId From ContentVersion where ContentDocumentId = : lstContentDocumentLink[0].ContentDocumentId order by Createddate Desc limit 1 ];     docpath = URL.getSalesforceBaseUrl().toExternalForm() +'/sfc/servlet.shepherd/version/download/'+lstContentVersion[0].Id+'?asPdf=false&operationContext=CHATTER';                     docName = lstContentVersion[0].Title;
                }
            } else if (pageName.equals('ManualContract')) {
                List<ContentDocumentLink> lstContentDocumentLink = [SELECT Id, ContentDocument.Title, LinkedEntityId, ContentDocumentId, Visibility, ShareType FROM ContentDocumentLink where LinkedEntityId = :quoteId order by ContentDocument.Createddate Desc limit 1];
                if (!lstContentDocumentLink.isEmpty()) {                    LIst<ContentVersion> lstContentVersion = [SELECT Id,Title, ContentDocumentId From ContentVersion where ContentDocumentId = : lstContentDocumentLink[0].ContentDocumentId order by Createddate Desc limit 1 ];      docpath = URL.getSalesforceBaseUrl().toExternalForm() +'/sfc/servlet.shepherd/version/download/'+lstContentVersion[0].Id+'?asPdf=false&operationContext=CHATTER';                    docName = lstContentVersion[0].Title;

                }
            }
        }
    }
    /**
    * @description redirect to sendmail page.
    * @param
    * @return pageReference
    */
    public pageReference sendMail() {
        String accountId = [select SBQQ__Account__c from SBQQ__Quote__c where id = :quoteId].SBQQ__Account__c ;
        String sContactId = [select SBQQ__PrimaryContact__c from SBQQ__Quote__c where id = :quoteId].SBQQ__PrimaryContact__c;
        pageReference pg = new pageReference('/apex/sendInvoice');
        pg.getParameters().put('DocId', docpath);
        pg.getParameters().put('DocName', docName);
        pg.getParameters().put('quoteId', quoteId.escapeHtml4());
        pg.getParameters().put('accountId', accountId);
        pg.getParameters().put('ContactId', sContactId);
        return pg;
    }
    /**
    * @description redirect to quote detail page.
    * @param
    * @return pageReference
    */
    public pageReference homePage() {
        if ((pageName.equals('Preview') || pageName.equals('sD'))){       
            list<ContentDocument> lstCntDocsToDelete = new list<ContentDocument>();
            Set<Id> lstContentDocument = new Set<Id>();
            for(ContentDocumentLink iterator : [SELECT ContentDocumentId FROM ContentDocumentLink WHERE LinkedEntityId = : quoteId]) {
                lstContentDocument.add(iterator.ContentDocumentId);
            }
            lstCntDocsToDelete = [ SELECT Id,Title From ContentDocument where Id IN : lstContentDocument AND Title like '%preview%' order by Createddate Desc limit 1 ];         
            if(!lstCntDocsToDelete.isEmpty() && lstCntDocsToDelete != null) {
                Database.delete(lstCntDocsToDelete, false);
                Database.emptyRecycleBin(lstCntDocsToDelete);
            }
        }
        String hostVal  = ApexPages.currentPage().getHeaders().get('Host');
        string url = 'https://' + hostVal + '/' + quoteId.escapeHtml4() ;
        pageReference pg = new pageReference(url);
        return pg;
    }
    /**
    * @description redirect to opportunity detail page.
    * @param
    * @return pageReference
    */
    public pageReference returnOppPage() {
        list<ContentDocument> lstCntDocsToDelete = new list<ContentDocument>();
        Set<Id> lstContentDocument = new Set<Id>();
        for(ContentDocumentLink iterator : [SELECT ContentDocumentId FROM ContentDocumentLink WHERE LinkedEntityId = : quoteId]) {
            lstContentDocument.add(iterator.ContentDocumentId);
        }
        lstCntDocsToDelete = [ SELECT Id,Title From ContentDocument where Id IN : lstContentDocument AND Title like '%preview%' order by Createddate Desc limit 1 ];         
        if(!lstCntDocsToDelete.isEmpty() && lstCntDocsToDelete != null) {
            Database.delete(lstCntDocsToDelete, false);
            Database.emptyRecycleBin(lstCntDocsToDelete);
        }
        String hostVal  = ApexPages.currentPage().getHeaders().get('Host');
        String oppId = [select SBQQ__Opportunity2__c from SBQQ__Quote__c where id = :quoteId].SBQQ__Opportunity2__c;
        string url = 'https://' + hostVal + '/' + oppId ;
        pageReference pg = new pageReference(url);
        return pg;
    }
    /**
    * @description Utility method to check string is empty are not.
    * @param strValue
    * @return Boolean
    */
    @TestVisible
    private Boolean isEmptyOrNull(String strValue) {return (strValue == null || strValue.trim().equals('')) ? true : false;
    }
    /**
        Method is used to send Docusign. This functionality is used when using send Docusign button is used and the preview of the document is done.
        Added By Avinash Shukla ::: For BK-2871/2973/2974
     */
    public Pagereference sendDocusign() {
        list<ContentDocument> lstCntDocsToDelete = new list<ContentDocument>();
        Set<Id> lstContentDocument = new Set<Id>();
        for(ContentDocumentLink iterator : [SELECT ContentDocumentId FROM ContentDocumentLink WHERE LinkedEntityId = : quoteId]) {
            lstContentDocument.add(iterator.ContentDocumentId);
        }
        lstCntDocsToDelete = [ SELECT Id,Title From ContentDocument where Id IN : lstContentDocument AND Title like '%preview%' order by Createddate Desc limit 1 ];         
        if(!lstCntDocsToDelete.isEmpty() && lstCntDocsToDelete != null) {
            Database.delete(lstCntDocsToDelete, false);
            Database.emptyRecycleBin(lstCntDocsToDelete);
        }
        string url = '';
        string templates = '';
        User sProfileName = [select Id, Profile.Name, UserRole.Name from User Where Id = :UserInfo.getUserId()]; // GGCKB-20
        String deliverables = '';
        if (oQuote.Quote_Line_Deliverables__c != null && oQuote.Show_Deliverables__c == true) {
            deliverables = [select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'Deliverables'].Id;
        }
        //update Rajesh kumar yadav BK-3326/3392
        string BrazilNationalBarterContract='';
        string BrazilInternationalBarterContract='';
        string NonBrazilInternationalBarterContract = ''; /*BK-21224*/
        string BrazilNationalFOCContract = '';
        string BrazilInternationalFOCContract = '';
        string NationalDigital ='';
        string InternationalDigital ='';
        if( !oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c && sProfileName.Profile.Name != 'Sales' && sProfileName.Profile.Name != 'Operations' && sProfileName.Profile.Name != 'GE BA Administrator' && sProfileName.Profile.Name != 'GE System Administrator' && sProfileName.Profile.Name != 'System Administrator'){
            BrazilInternationalBarterContract = [select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'Brazil International Barter Contract' limit 1].Id;
            System.debug('BrazilInternationalBarterContract>> '+BrazilInternationalBarterContract);
        }else if(!oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c && (sProfileName.Profile.Name == 'Sales' || sProfileName.Profile.Name == 'Operations' || sProfileName.Profile.Name == 'GE BA Administrator'|| sProfileName.Profile.Name == 'GE System Administrator'|| sProfileName.Profile.Name == 'System Administrator')){
            NonBrazilInternationalBarterContract = [select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'Non_Brazil_international_Barter_Contract' limit 1].Id;/*BK-21224*/
            System.debug('NonBrazilInternationalBarterContract>> '+NonBrazilInternationalBarterContract);
        }else if( oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c){
            BrazilNationalBarterContract = [select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'Brazil National Barter Contract' limit 1].Id;
        }else if(!oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Total_FOC_Product_Count__c >= 1){
            BrazilInternationalFOCContract = [select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'Brazil International FOC Contract' limit 1].Id;
        }else if(oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Total_FOC_Product_Count__c >= 1){
            BrazilNationalFOCContract =[select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'Brazil National FOC Contract' limit 1].Id;
        }else if(oQuote.Is_a_Local_Company__c && oQuote.Contract_Type__c =='Digital'){
            NationalDigital =[select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'BRAZIL National Digital Only Contract' limit 1].Id;
        }else if(!oQuote.Is_a_Local_Company__c && oQuote.Contract_Type__c =='Digital'){
            InternationalDigital =[select id from APXTConga4__Conga_Template__c where APXTConga4__Name__c = 'BRAZIL International Digital Only Contract' limit 1].Id;
        }
        
        //Rajesh kumar yadav BK-3326/3392
        if (template == 'Quote'){
            /*if (oQuote.SBQQ__Opportunity2__r.EventEdition__r.Enable_Additional_Documents_in_Docusign__c){                url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__PrimaryContact__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&APDF=0&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&AttachmentId=' + pDAs + '&BML=Generating+Quote+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + CongaAdditionalDocParam;
            }
            else { */
            // New URL redirect for Quote BK-2871 ::: Avinash Shukla.
            DateTime objDate1 = DateTime.now();
            docName = oQuote.Name + '-' + String.valueOf(objDate1) + '-SignedQuote';
            url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__PrimaryContact__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&APDF=0&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&AttachmentId=' + pDAs + '&BML=Generating+Quote+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + congaAdditionalParams;
            //}
            
        }else if (template == 'Contract') {
            DateTime objDate1 = DateTime.now();
            docName = oQuote.Name + '-' + String.valueOf(objDate1) + '-SignedContract';
            if (!oQuote.Is_a_Local_Company__c) {
                //BK-6386 by Aishwarya Kumar
                if(!oQuote.Is_a_Local_Company__c && oQuote.Contract_Type__c =='Digital'){
                    if(String.isNotBlank(InternationalDigital)) {
                        templates = InternationalDigital + ',' + deliverables; 
                    }
                }
                //update Rajesh kumar yadav BK-3326
                else if( !oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c){  
                    if (String.isNotBlank(BrazilInternationalBarterContract)){
                        if (oQuote.SBQQ__Type__c == 'Amendment' && (sProfileName.Profile.Name == 'Sales-Brasil' || (sProfileName.Profile.Name == 'SSC Finance-Accounting' && sProfileName.UserRole.Name == 'SSC-Brazil'))){ 
                            templates = BrazilInternationalBarterContract + ',' + deliverables;
                        }else{
                            templates = BrazilInternationalBarterContract + ',' + deliverables;
                        }
                    }
                    /*BK-21224 : if condition for Non Brazil International Barter Contracts start*/
                    if(String.isNotBlank(NonBrazilInternationalBarterContract)){
                        if(sProfileName.Profile.Name == 'Sales' || sProfileName.Profile.Name == 'Operations' || sProfileName.Profile.Name == 'GE BA Administrator'|| sProfileName.Profile.Name == 'GE System Administrator'|| sProfileName.Profile.Name == 'System Administrator'){
                            templates = NonBrazilInternationalBarterContract+ ',' + deliverables;
                        }
                    }
                    /*BK-21224 : if condition end*/
                }
                //update Rajesh kumar yadav BK-3392
                //  
                else if(!oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Total_FOC_Product_Count__c >=1){
                    if (String.isNotBlank(BrazilInternationalFOCContract)){
                        if(oQuote.SBQQ__Type__c == 'Amendment' && (sProfileName.Profile.Name == 'Sales-Brasil' || (sProfileName.Profile.Name == 'SSC Finance-Accounting' && sProfileName.UserRole.Name == 'SSC-Brazil'))){
                            templates = BrazilInternationalFOCContract + ',' + deliverables; 
                        }else{
                            templates = BrazilInternationalFOCContract + ',' + deliverables;
                        }
                    }
                }
                else{
                    //BK-6268
                    oQuoteTCID = [select id, term_conditionIds__c, conga_contract_template_id__c from SBQQ__Quote__c where id =: quoteId limit 1];   
                    if (String.isBlank(oQuote.term_conditionIds__c)){
                        //BK-6268
                        if (!String.isBlank(oQuoteTCID.term_conditionIds__c)){
                            templates = oQuote.conga_contract_template_id__c + ',' + deliverables+ ',' + oQuoteTCID.term_conditionIds__c;
                        }else{
                            templates = oQuote.conga_contract_template_id__c + ',' + deliverables;
                        }
                    }else{
                        templates = oQuote.conga_contract_template_id__c + ',' + deliverables + ',' + termAndCondition;
                        /*if (oQuote.SBQQ__Type__c == 'Amendment' && (sProfileName.Profile.Name == 'Sales-Brasil' || (sProfileName.Profile.Name == 'SSC Finance-Accounting' && sProfileName.UserRole.Name == 'SSC-Brazil'))) {
                        templates = oQuote.conga_contract_template_id__c + ',' + deliverables; } 
                        else { templates = oQuote.conga_contract_template_id__c + ',' + deliverables + ',' + termAndCondition; } */
                    }
                }
            }
            else{ 
                if(oQuote.Is_a_Local_Company__c && oQuote.Contract_Type__c =='Digital'){
                    if(String.isNotBlank(NationalDigital)){
                        templates = NationalDigital; 
                    }
                }
                    //update Rajesh kumar yadav BK-3326
                else if(oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c){
                    //for National company
                    if(String.isNotBlank(BrazilNationalBarterContract)){
                        if(oQuote.SBQQ__Type__c == 'Amendment' && (sProfileName.Profile.Name == 'Sales-Brasil' || (sProfileName.Profile.Name == 'SSC Finance-Accounting' && sProfileName.UserRole.Name == 'SSC-Brazil'))){
                            templates = BrazilNationalBarterContract;
                        }
                        else{
                            templates = BrazilNationalBarterContract;
                        }
                    }
                }//update Rajesh kumar yadav BK-3392
                else if(oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Total_FOC_Product_Count__c >= 1){
                    //for National company
                    if(String.isNotBlank(BrazilNationalFOCContract)){
                        if (oQuote.SBQQ__Type__c == 'Amendment' && (sProfileName.Profile.Name == 'Sales-Brasil' || (sProfileName.Profile.Name == 'SSC Finance-Accounting' && sProfileName.UserRole.Name == 'SSC-Brazil'))){
                            templates = BrazilNationalBarterContract;
                        }else{
                            templates = BrazilNationalFOCContract;
                        }
                    }
                }
                else{
                    National_Contract_Template__c temp = [select id, name, Event_Edition__c, Conga_Template__c, Term_Conditions__c 
                                                          from National_Contract_Template__c where Event_Edition__r.name = : oQuote.Quote_Event_Edition__c 
                                                          and Type__c = 'Contract Template'];
                        /*
                        if (oQuote.SBQQ__Type__c == 'Amendment' && (sProfileName.Profile.Name == 'Sales-Brasil' || (sProfileName.Profile.Name == 'SSC Finance-Accounting' && sProfileName.UserRole.Name == 'SSC-Brazil'))) { templates = temp.Conga_Template__c;
                        } 
                        else {
                            templates = temp.Conga_Template__c + ',' + temp.Term_Conditions__c;
                            oQuote.National_contract_and_TC_Ids__c = templates; 
                        } */
                        /*****
                        if (oQuote.SBQQ__Type__c == 'Amendment' ) { 
                            templates = temp.Conga_Template__c + ',' + temp.Term_Conditions__c;
                            oQuote.National_contract_and_TC_Ids__c = templates; }else {
                        templates = temp.Conga_Template__c + ',' + temp.Term_Conditions__c;
                        oQuote.National_contract_and_TC_Ids__c = templates;
                        } ****/
                    templates = temp.Conga_Template__c + ',' + temp.Term_Conditions__c;
                    oQuote.National_contract_and_TC_Ids__c = templates;
                }
            }
            //update oQuote;
            //After update Docusign URL are updated '+'&DS7=7&DocuSignEndPoint=Demo'' BK-4270 Rajesh kumar yadav
            Application_Bypass__c appBypass = Application_Bypass__c.getInstance();
            if (appBypass.Docusign_Counter_Sign__c && oQuote.Allow_Docusign_Counter_Sign__c) {
                String docusignParams = System.label.Docusign_Counter_Sign;
                String docusignParamsFourSign = System.label.Docusign_Counter_Four_Sign; String templatesName = '';
                if (templates != null && templates != '') {
                    String tempname = templates.substringBefore(',');
                    templatesName = [SELECT Id, Name, APXTConga4__Name__c FROM APXTConga4__Conga_Template__c where id = :tempname].APXTConga4__Name__c;
                }
                if(String.isNotBlank(templatesName)){
                    if(oQuote.Contract_Type__c =='Digital' && (templatesName.contains('InternationalDigital') || (templatesName.contains('NationalDigital'))) ){

                        url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + templates + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Witness_Contact__c + '&DocuSignR3ID=' + oQuote.Event_Director__c + '&DocuSignR4ID=' + oQuote.Event_Director__c + '&DocuSignR5ID=' + oQuote.ID + '&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParamsFourSign + congaAdditionalParamsBrazil;
                    }
                    else if(oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c){
                        if (templatesName.contains('Brazil International Barter Contract') && !oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c ) {
                            url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Event_Director__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParams + congaAdditionalParamsBrazil;
                            System.debug('Brazil International URL : '+url);
                        }
                        else{
                            url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + templates + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Witness_Contact__c + '&DocuSignR3ID=' + oQuote.Event_Director__c + '&DocuSignR4ID=' + oQuote.Event_Director__c + '&DocuSignR5ID=' + oQuote.ID + '&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParamsFourSign + congaAdditionalParamsBrazil;
                            System.debug('Brazil National URL : '+url);
                        }
                        /*BK-21224 if condition to create Url for Non Brazil International Barter Opportunity contract.*/
                        if (templatesName.contains('Non_Brazil_international_Barter_Contract') && !oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Is_Barter_Opportunity__c ) {
                            url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Event_Director__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParams + congaAdditionalParamsBrazil;
                            System.debug('Non Brazil International URL : '+url);
                        }

                    }else if(oQuote.SBQQ__Opportunity2__r.Total_FOC_Product_Count__c >= 1){ if (templatesName.contains('Brazil International FOC Contract') && !oQuote.Is_a_Local_Company__c && oQuote.SBQQ__Opportunity2__r.Total_FOC_Product_Count__c >= 1) {                          url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Event_Director__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParams + congaAdditionalParamsBrazil;
                        } else{
                            url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + templates + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Witness_Contact__c + '&DocuSignR3ID=' + oQuote.Event_Director__c + '&DocuSignR4ID=' + oQuote.Event_Director__c + '&DocuSignR5ID=' + oQuote.ID + '&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParamsFourSign + congaAdditionalParamsBrazil; }
                    }
                    else{
                        if(templatesName.contains('BRAZIL InterNational Contract') && (oQuote.SBQQ__Type__c == 'Amendment' || oQuote.SBQQ__Type__c == 'Quote')) { url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + templates + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Witness_Contact__c + '&DocuSignR3ID=' + oQuote.Event_Director__c + '&DocuSignR4ID=' + oQuote.Event_Director__c + '&DocuSignR5ID=' + oQuote.ID + '&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParamsFourSign + congaAdditionalParamsBrazil;
                        } else if (templatesName.contains('BRAZIL InterNational Contract')) {  url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Event_Director__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParams + congaAdditionalParamsBrazil; 
                        }else { 
                            url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sUrl.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + templates + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__Opportunity2__r.Legal_Representative_1__c + '&DocuSignR2ID=' + oQuote.Witness_Contact__c + '&DocuSignR3ID=' + oQuote.Event_Director__c + '&DocuSignR4ID=' + oQuote.Event_Director__c + '&DocuSignR5ID=' + oQuote.ID + '&OFN=' + docName + '&UF0=1&MFTS0=template__c&MFTSValue0=' + template + '&BML=Generating+Contract+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + '&DocuSignBrandName=Informa GE&AWD=2' + docusignParamsFourSign + congaAdditionalParamsBrazil;
                        }
                    }  
                  }
            }
            else {
                if (oQuote.SBQQ__Opportunity2__r.EventEdition__r.Enable_Additional_Documents_in_Docusign__c){                    url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sURL.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__PrimaryContact__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&APDF=0&UF0=1&MFTS0=template__c&MFTSValue0=' + template +  '&BML=Generating+Quote+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + CongaAdditionalDocParam;
                }
                else {
                    url = '/apex/APXTConga4__Conga_Composer?sessionId=' + sessionId.escapeHtml4() + '&serverUrl=' + sURL.escapeHtml4() + '&Id=' + quoteId.escapeHtml4() + '&TemplateId=' + tId + '&QueryId=' + congaQueries + '&DocuSignVisible=1&DocuSignR1ID=' + oQuote.SBQQ__PrimaryContact__c + '&DocuSignR1Role=Signer+1&DocuSignR1Type=Signer&DocuSignR1RoutingOrder=1&OFN=' + docName + '&APDF=0&UF0=1&MFTS0=template__c&MFTSValue0=' + template +  '&BML=Generating+Quote+for+' + oQuote.Primary_Contact_Info__c + '&MFTS1=Version__c&MFTSValue1=' + oQuote.Next_Version__c + '&DefaultPDF=1&Culture=' + cC + '&CurrencyCulture=' + cC + congaAdditionalParams;
                }
            }
        }
        pageReference pg = new pageReference(url);
        return pg;
    }
}